<template>
  <iframe
    id="shadowRender"
    :force="isRenderIframe"
    @update-iframe="updateIframe" />
</template>

<script>
// The plugins that use it should updateIframe() it when it is necessary.
// For a work correct in the plugin need a timeout for get the new render.
import _ from 'lodash';

export default {
  name: 'ShadowRender',
  data() {
    return {
      headEmail: '',
    };
  },
  computed: {
    campaign() {
      return this.$store.getters['campaign/campaign'];
    },
    modules() {
      return this.$store.getters['campaign/modules'];
    },
    isRenderIframe() {
      return this.setHeadEmail();
    },
  },
  methods: {
    setHeadEmail() {
      if (!this.headEmail && this.campaign.campaign_id) {
        const url = `/template/email-preview/${this.campaign.campaign_id}?no_body=true`;
        const request = Application.utils.doAjax(url, {
          type: 'GET',
          dataType: 'html',
          data: {
            campaign_id: this.campaign.campaign_id,
          },
        });
        // Ajax: On Success
        request.done((response) => {
          this.headEmail = response;
        });
        // Ajax: On Fail
        request.fail(() => {
        });
      }
    },
    isRenderSetting(plugin) {
      return plugin.enabled && plugin.needShadowRender;
    },
    updateIframe: _.debounce(function update() {
      let html = $('table#emailCanvas').clone();
      html.find('.st-remove-element').remove();
      html = Application.utils.removeWrappers(html);
      html = this.headEmail ? this.headEmail.replace('</body>', `${html[0].outerHTML}</body>`) : html[0].outerHTML;

      document.getElementById('shadowRender').contentWindow.document.open();
      document.getElementById('shadowRender').contentWindow.document.write(html);
      document.getElementById('shadowRender').contentWindow.document.close();
    }, 100),
  },
};
</script>
<style scoped>
iframe#shadowRender {
  opacity: 0;
  position: fixed;
  left: 110%;
  height: 0;
  width: 1000px;
  border: 0;
}
</style>
